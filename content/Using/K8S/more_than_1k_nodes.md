+++
title = 'More than 1k Nodes'
date = 2024-03-07T15:00:59+08:00
weight = 20
+++

åœ¨è¿™ä¸ªé‡çº§ä¸Šï¼ŒK8s ä¸å†åªæ˜¯â€œèƒ½è·‘å°±è¡Œâ€ï¼Œè€Œæ˜¯è¿›å…¥**å¯æ‰©å±•æ€§ã€ç¨³å®šæ€§ã€å¯è§‚æµ‹æ€§å’Œèµ„æºæ•ˆç‡**çš„å·¥ç¨‹åŒ–æŒ‘æˆ˜ã€‚ä¸‹é¢æˆ‘ä»æ¶æ„ã€æ§åˆ¶é¢ã€èŠ‚ç‚¹ç®¡ç†ã€ç½‘ç»œã€å­˜å‚¨ã€å®‰å…¨å’Œè¿ç»´å‡ ä¸ªæ–¹é¢ç³»ç»Ÿè®²è§£ã€‚

---

## ğŸ§  ä¸€ã€æ€»ä½“æ€è·¯ï¼šå¤§è§„æ¨¡é›†ç¾¤çš„æœ¬è´¨æŒ‘æˆ˜

å½“èŠ‚ç‚¹è§„æ¨¡è¶…è¿‡ 500ï½1000 æ—¶ï¼ŒKubernetes çš„ç“¶é¢ˆé€šå¸¸å‡ºç°åœ¨ï¼š

* **æ§åˆ¶å¹³é¢ï¼ˆAPI Server / etcdï¼‰å‹åŠ›è¿‡å¤§**ï¼›
* **è°ƒåº¦å™¨ååä¸è¶³**ï¼›
* **èµ„æºå¯¹è±¡ï¼ˆPod / Node / Secret / ConfigMap ç­‰ï¼‰è¿‡å¤šï¼Œå¯¼è‡´ List/Watch å»¶è¿Ÿ**ï¼›
* **ç½‘ç»œå’Œ CNI æ’ä»¶åœ¨é«˜å¹¶å‘ä¸‹æ€§èƒ½ä¸‹é™**ï¼›
* **ç›‘æ§ã€æ—¥å¿—ã€äº‹ä»¶ç³»ç»Ÿçš„æ•°æ®é‡çˆ†ç‚¸**ï¼›
* **ç»´æŠ¤å’Œå‡çº§å˜å¾—æåº¦å¤æ‚**ã€‚

æ‰€ä»¥ï¼Œå¤§è§„æ¨¡é›†ç¾¤çš„é‡ç‚¹æ˜¯ï¼š

> **æ§åˆ¶å¹³é¢åˆ†å±‚ã€èŠ‚ç‚¹æ± åˆ†åŒºã€æµé‡éš”ç¦»ã€è§‚æµ‹ä¸è°ƒä¼˜ã€‚**

---

## ğŸ—ï¸ äºŒã€æ§åˆ¶å¹³é¢ï¼ˆControl Planeï¼‰

### 1. etcd ä¼˜åŒ–

* **ç‹¬ç«‹éƒ¨ç½²**ï¼šä¸è¦å’Œ kube-apiserver æ··å¸ƒï¼Œæœ€å¥½æ˜¯ç‹¬ç«‹çš„é«˜æ€§èƒ½èŠ‚ç‚¹ï¼ˆNVMe SSDã€æœ¬åœ°ç›˜ï¼‰ã€‚
* **ä½¿ç”¨ etcd v3.5+**ï¼ˆæ€§èƒ½æ”¹è¿›æ˜æ˜¾ï¼‰ï¼Œå¹¶å¼€å¯å‹ç¼©å’Œå¿«ç…§æœºåˆ¶ã€‚
* **è°ƒå¤§ `--max-request-bytes` å’Œ `--quota-backend-bytes`**ï¼Œé¿å…è¿‡è½½ã€‚
* **å®šæœŸ defrag**ï¼šå¯ç”¨ CronJob è‡ªåŠ¨åŒ–ã€‚
* **ä¸è¦å­˜æ”¾çŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡**ï¼ˆä¾‹å¦‚é¢‘ç¹æ›´æ–°çš„ CRD çŠ¶æ€ï¼‰ï¼Œå¯ä»¥è€ƒè™‘ç”¨å¤–éƒ¨ç¼“å­˜ç³»ç»Ÿï¼ˆå¦‚ Redis æˆ– SQLï¼‰ã€‚

### 2. API Server æ‰©å±•ä¸ä¿æŠ¤

* ä½¿ç”¨ **è´Ÿè½½å‡è¡¡**ï¼ˆHAProxyã€NGINXã€ELBï¼‰åœ¨å¤š API Server ä¹‹é—´åˆ†æµï¼›
* è°ƒæ•´ï¼š

  * `--max-mutating-requests-inflight`
  * `--max-requests-inflight`
  * `--target-ram-mb`
* åˆç†è®¾ç½® `--request-timeout`ï¼Œé˜²æ­¢ watch å¡æ­»ï¼›
* é™åˆ¶å¤§é‡ client watch è¡Œä¸ºï¼ˆPrometheusã€controller-manager ç­‰ï¼‰ï¼›
* å¯¹ client ä¾§ä½¿ç”¨ **aggregator** æˆ– **read-only proxy** æ¥é™ä½è´Ÿè½½ã€‚

### 3. Scheduler & Controller Manager

* **å¤šè°ƒåº¦å™¨å®ä¾‹ï¼ˆleader electionï¼‰**ï¼›
* å¯ç”¨ **è°ƒåº¦ç¼“å­˜ï¼ˆSchedulerCacheï¼‰ä¼˜åŒ–**ï¼›
* è°ƒæ•´ï¼š

  * `--kube-api-qps`ã€`--kube-api-burst`ï¼›
  * è°ƒåº¦ç®—æ³•çš„ backoff ç­–ç•¥ï¼›
* å¯¹è‡ªå®šä¹‰ Operator å»ºè®®ä½¿ç”¨ **workqueue with rate limiters** é˜²æ­¢é£æš´ã€‚

---

## ğŸ§© ä¸‰ã€èŠ‚ç‚¹ä¸ Pod ç®¡ç†

### 1. èŠ‚ç‚¹åˆ†åŒºä¸æ‹“æ‰‘

* æŒ‰åŠŸèƒ½/ä½ç½®åˆ’åˆ† Node Poolï¼ˆå¦‚ GPU/CPU/IO å¯†é›†å‹ï¼‰ï¼›
* ä½¿ç”¨ **Topology Spread Constraints** é¿å…é›†ä¸­è°ƒåº¦ï¼›
* è€ƒè™‘ç”¨ **Cluster Federation (KubeFed)** æˆ– **å¤šä¸ªé›†ç¾¤ + é›†ä¸­ç®¡ç†ï¼ˆå¦‚ ArgoCD å¤šé›†ç¾¤ã€Karmadaã€Fleetï¼‰**ã€‚

### 2. èŠ‚ç‚¹ç”Ÿå‘½å‘¨æœŸ

* æ§åˆ¶ kubelet å¿ƒè·³é¢‘ç‡ (`--node-status-update-frequency`)ï¼›
* é€šè¿‡ **Node Problem Detector (NPD)** è‡ªåŠ¨æ ‡è®°å¼‚å¸¸èŠ‚ç‚¹ï¼›
* ç›‘æ§ Pod eviction rateï¼Œé˜²æ­¢èŠ‚ç‚¹é¢‘ç¹æ¼‚ç§»ï¼›
* å¯ç”¨ **graceful node shutdown** æ”¯æŒã€‚

### 3. é•œåƒä¸å®¹å™¨è¿è¡Œæ—¶

* é•œåƒé¢„çƒ­ï¼ˆImage pre-pullï¼‰ï¼›
* ä½¿ç”¨ **é•œåƒä»“åº“ä»£ç†ï¼ˆHarbor / registry-mirrorï¼‰**ï¼›
* è€ƒè™‘ containerd ä»£æ›¿ Dockerï¼›
* å®šæœŸæ¸…ç† `/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots`ã€‚

---

## ğŸŒ å››ã€ç½‘ç»œï¼ˆCNIï¼‰

### 1. CNI é€‰æ‹©ä¸è°ƒä¼˜

* å¤§è§„æ¨¡ä¸‹ä¼˜é€‰ï¼š

  * **Calico (BGP æ¨¡å¼)**ï¼›
  * **Cilium (eBPF)**ï¼›
  * æˆ–ä½¿ç”¨äº‘åŸç”Ÿæ–¹æ¡ˆï¼ˆAWS CNI, Azure CNIï¼‰ã€‚
* é™ä½ ARP / è·¯ç”±è¡¨å‹åŠ›ï¼š

  * ä½¿ç”¨ **IPAM å­ç½‘åˆ†æ®µ**ï¼›
  * å¼€å¯ Cilium çš„ **ClusterMesh** åˆ†å±‚ï¼›
* è°ƒæ•´ `conntrack` è¡¨å¤§å°ï¼ˆ`net.netfilter.nf_conntrack_max`ï¼‰ã€‚

### 2. Service & DNS

* å¯ç”¨ **CoreDNS ç¼“å­˜**ï¼›
* å¯¹å¤§è§„æ¨¡ Service åœºæ™¯ï¼Œè€ƒè™‘ **Headless Service + ExternalName**ï¼›
* ä¼˜åŒ– kube-proxyï¼š

  * ä½¿ç”¨ **IPVS æ¨¡å¼**ï¼›
  * æˆ– **Cilium service LB**ï¼›
* å¦‚æœ Service æ•°é‡éå¸¸å¤šï¼Œå¯æ‹†åˆ† namespace çº§ DNS åŸŸã€‚

---

## ğŸ’¾ äº”ã€å­˜å‚¨ï¼ˆCSIï¼‰

* ä½¿ç”¨ **åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿ**ï¼ˆCephã€Longhornã€OpenEBSã€CSI-HostPathï¼‰ï¼›
* é¿å…é«˜é¢‘å° I/O çš„ PVCï¼›
* å®šæœŸæ¸…ç†åƒµå°¸ PV/PVCï¼›
* å¯¹ CSI driver å¼€å¯é™æµä¸é‡è¯•æœºåˆ¶ã€‚

---

## ğŸ”’ å…­ã€å®‰å…¨ä¸è®¿é—®æ§åˆ¶

* å¼€å¯ **RBAC ä¸¥æ ¼æ§åˆ¶**ï¼›
* é™åˆ¶ namespace çº§èµ„æºä¸Šé™ï¼ˆResourceQuota, LimitRangeï¼‰ï¼›
* å®¡è®¡æ—¥å¿—ï¼ˆAudit Policyï¼‰å¼‚æ­¥å­˜å‚¨ï¼›
* å¯¹å¤–æ¥å£ç»Ÿä¸€èµ° Ingress Controllerï¼›
* å¦‚æœæœ‰ Operator æˆ– CRD èµ„æºæš´æ¶¨ï¼Œè®°å¾—å®šæœŸæ¸…ç†è¿‡æœŸå¯¹è±¡ã€‚

---

## ğŸ“ˆ ä¸ƒã€å¯è§‚æµ‹æ€§ä¸ç»´æŠ¤

### 1. ç›‘æ§

* Prometheus é›†ç¾¤åŒ–ï¼ˆThanos / VictoriaMetricsï¼‰ï¼›
* ä¸ç›´æ¥ç›‘æ§æ‰€æœ‰ Podï¼Œå¯æŠ½æ ·æˆ–èšåˆï¼›
* kube-state-metrics ä¸ cAdvisor æ•°æ®è¦é™æµã€‚

### 2. æ—¥å¿—

* ç»Ÿä¸€æ—¥å¿—æ”¶é›†ï¼ˆLoki / Elasticsearch / Vectorï¼‰ï¼›
* æ—¥å¿—é‡æ§åˆ¶ç­–ç•¥ï¼ˆé‡‡æ ·ã€å‹ç¼©ã€æ¸…ç†ï¼‰ã€‚

### 3. å‡çº§ä¸æµ‹è¯•

* ä½¿ç”¨ **ç°åº¦å‡çº§ / Node pool rolling**ï¼›
* æ¯æ¬¡å‡çº§å‰è·‘ e2e æµ‹è¯•ï¼›
* å¯¹æ§åˆ¶å¹³é¢å•ç‹¬åšå¿«ç…§å’Œå¤‡ä»½ï¼ˆetcd snapshotï¼‰ã€‚

---

## âš™ï¸ å…«ã€æ€§èƒ½è°ƒä¼˜ä¸å®è·µç»éªŒ

* è°ƒæ•´ kubelet QPS é™åˆ¶ï¼š

  ```bash
  --kube-api-qps=100 --kube-api-burst=200
  ```
* åˆç†çš„ Pod æ•°é‡æ§åˆ¶ï¼š

  * å•èŠ‚ç‚¹ä¸è¶…è¿‡ 110 Podsï¼›
  * å• namespace å»ºè®® < 5000 Podsï¼›
  * æ€»ä½“ç›®æ ‡ï¼š1k èŠ‚ç‚¹ â†’ 5~10 ä¸‡ Pods ä»¥å†…ã€‚
* ä½¿ç”¨ **CRD Sharding / ç¼©å‡ CRD çŠ¶æ€å­—æ®µ**ï¼›
* é¿å…å¤§é‡çŸ­ç”Ÿå‘½å‘¨æœŸ Jobï¼Œå¯ç”¨ CronJob + TTLController æ¸…ç†ã€‚

---

## ğŸ§­ ä¹ã€æ‰©å±•æ–¹å‘

å½“è§„æ¨¡ç»§ç»­ä¸Šå‡ï¼ˆ>3000 èŠ‚ç‚¹ï¼‰æ—¶ï¼Œå¯ä»¥è€ƒè™‘ï¼š

* **å¤šé›†ç¾¤æ¶æ„ï¼ˆCluster Federation / Karmada / Rancher Fleetï¼‰**
* **æ§åˆ¶å¹³é¢åˆ†å±‚ï¼ˆcell-based control planeï¼‰**
* **API Aggregation Layer + Custom Scheduler**

---

