+++
title = 'Flannel VS Calico'
date = 2024-03-07T15:00:59+08:00
weight = 140
+++

Calico 和 Flannel 是 Kubernetes 中最著名和最常见的两种网络插件（CNI），但它们的设计哲学、实现方式和能力有显著区别。

简单来说：
*   **Flannel** 追求的是**简单和易用**，提供足够的基础网络功能。
*   **Calico** 追求的是**性能和功能**，提供强大的网络策略和高性能网络。

下面我们从多个维度进行详细对比。

---

### 核心对比一览表

| 特性 | Flannel | Calico |
| :--- | :--- | :--- |
| **核心设计哲学** | 简单、最小化 | 高性能、功能丰富 |
| **网络模型** | **Overlay 网络** | **纯三层路由**（可选 Overlay） |
| **数据平面** | VXLAN（推荐）、Host-gw、UDP | **BGP**（推荐）、VXLAN、Windows |
| **性能** | 较好（VXLAN有封装开销） | **极高**（BGP模式下无封装开销） |
| **网络策略** | **不支持**（需安装Cilium等） | **原生支持**（强大的网络策略） |
| **安全性** | 基础 | **高级**（基于标签的微隔离） |
| **配置与维护** | 非常简单，几乎无需配置 | 相对复杂，功能多配置项也多 |
| **适用场景** | 学习、测试、中小型集群，需求简单 | 生产环境、大型集群、对性能和安全要求高 |

---

### 深入剖析

#### 1. 网络模型与工作原理

这是最根本的区别。

*   **Flannel (Overlay Network)**：
    *   **工作原理**：它在底层物理网络之上再构建一个虚拟的“覆盖网络”。当数据包从一个节点的Pod发送到另一个节点的Pod时，Flannel会将它**封装**在一个新的网络包中（如VXLAN）。
    *   **类比**：就像在一封普通信件（Pod的原始数据包）外面套了一个标准快递袋（VXLAN封装），快递系统（底层网络）只关心快递袋上的地址（节点IP），不关心里面的内容。到达目标节点后，再拆开快递袋，取出里面的信。
    *   **优势**：对底层网络要求低，只要节点之间IP能通即可，兼容性好。
    *   **劣势**：封装和解封装有额外的CPU开销，并且会增加数据包的大小（ overhead），导致性能略有下降。

*   **Calico (Pure Layer 3)**：
    *   **工作原理（BGP模式）**：它不使用封装，而是使用**BGP路由协议**。每个K8s节点都像一个路由器，它通过BGP协议向集群中的其他节点宣告：“发往这些Pod IP的流量，请送到我这里来”。
    *   **类比**：就像整个数据中心是一个大的邮政系统，每个邮局（节点）都知道去往任何地址（Pod IP）的最短路径，信件（数据包）可以直接投递，无需额外包装。
    *   **优势**：**性能高**，无封装开销，延迟低，吞吐量高。
    *   **劣势**：要求底层网络必须支持BGP或者支持主机路由（某些云平台或网络设备可能需要特定配置）。

> **注意**：Calico也支持VXLAN模式（通常用于网络策略要求BGP但底层网络不支持的场景），但其最佳性能是在BGP模式下实现的。

#### 2. 网络策略

这是两者功能性的一个巨大分水岭。

*   **Flannel**：**本身不提供任何网络策略能力**。它只负责打通网络，让所有Pod默认可以相互通信。如果你需要实现Pod之间的访问控制（微隔离），你必须额外安装一个网络策略控制器，如 **Cilium** 或 **Calico本身**（可以只使用其策略部分，与Flannel叠加使用）。

*   **Calico**：**原生支持强大的Kubernetes NetworkPolicy**。你可以定义基于Pod标签、命名空间、端口、协议甚至DNS名称的精细规则，来控制Pod的入站和出站流量。这对于实现“零信任”安全模型至关重要。

#### 3. 性能

*   **Calico (BGP模式)**：由于其**纯三层**的转发机制，无需封装，数据包是原生IP包，其**延迟更低，吞吐量更高**，CPU消耗也更少。
*   **Flannel (VXLAN模式)**：由于存在VXLAN的封装头（通常50字节 overhead），最大传输单元会变小，封装/解封装操作也需要CPU参与，性能相比Calico BGP模式要低一些。但其 **Host-gw** 后端模式性能很好，前提是节点在同一个二层网络。

#### 4. 生态系统与高级功能

*   **Calico**：功能非常丰富，远不止基础网络。
    *   **网络策略**：如上所述，非常强大。
    *   **IPAM**：灵活的IP地址管理。
    *   **服务网格集成**：与Istio有深度集成，可以实施全局的服务到服务策略。
    *   **Windows支持**：对Windows节点有良好的支持。
    *   **网络诊断工具**：提供了 `calicoctl` 等强大的运维工具。
*   **Flannel**：功能相对单一，就是做好网络连通性。它“小而美”，但缺乏高级功能。

---

### 如何选择？

#### 选择 Flannel 的情况：

*   **新手用户**：想要快速搭建一个K8s集群，不想纠结于复杂的网络配置。
*   **测试或开发环境**：需求简单，只需要Pod能通。
*   **中小型集群**：对性能和高级网络策略没有硬性要求。
*   **底层网络受限**：无法配置BGP或主机路由的环境（例如某些公有云基础网络）。

#### 选择 Calico 的情况：

*   **生产环境**：对稳定性和性能有高要求。
*   **大型集群**：需要高效的路由和可扩展性。
*   **安全要求高**：需要实现Pod之间的网络隔离（微隔离）。
*   **对网络性能极度敏感**：例如AI/ML训练、高频交易等场景。
*   **底层网络可控**：例如在自建数据中心或云上支持BGP的环境。

### 总结

|  | **Flannel** | **Calico** |
| :--- | :--- | :--- |
| **核心价值** | **简单可靠** | **功能强大** |
| **好比买车** | 丰田卡罗拉：皮实、省心、够用 | 宝马/奥迪：性能强劲、功能齐全、操控精准 |
| **一句话总结** | “让我快速把网络打通” | “我要一个高性能、高安全性的生产级网络” |

在现代Kubernetes部署中，尤其是生产环境，**Calico因其卓越的性能和原生的安全能力，已经成为更主流和推荐的选择**。而Flannel则在那些“只要能通就行”的简单场景中，依然保持着它的价值。